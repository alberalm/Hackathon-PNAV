<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Explorador de Rutas Naturales</title>
  <style>

      html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* desactiva scroll de p√°gina */
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f7f4;
      color: #2d3e2f;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f7f4;
      color: #2d3e2f;
    }
    

    header {
      background-color: #3a7d44;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
    }

    .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 20px;
      background-color: #d9f2e6;
      border-bottom: 2px solid #a0d3b4;
      justify-content: center;
    }

    select, input[type="date"] {
      padding: 8px;
      border: 1px solid #a0d3b4;
      border-radius: 6px;
      background-color: #f5fff8;
      font-size: 1rem;
    }

    .taxones {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .taxones label {
      background-color: #e1f4ea;
      border: 1px solid #a0d3b4;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .contenido {
      display: flex;
      gap: 20px;
      padding: 20px;
     
     height: 750px; /* Ajusta seg√∫n el tama√±o del header */
      align-items: stretch;
    }
    /* Contenedor scrollable para la tabla */
    
   table {
  display: block;            /* para que admita overflow */
  width: 60%;
  border-collapse: collapse;
  background-color: white;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

/* Cabecera fija, ocupa todo el ancho disponible */
thead {
  display: table;
  width: 100%;
  table-layout: fixed;       /* columnas fijas seg√∫n ancho de celda */
}

.controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 10px;   /* o el espacio que quieras */
}

.controls .descripcion-input {
  flex: 1;            /* ocupa todo el espacio restante */
  margin-right: 12px; /* separa un poco del bot√≥n */
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.controls .descripcion-btn {
  flex: 0 0 auto;
  padding: 6px 12px;
  background-color: #3a7d44;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.controls .descripcion-btn:hover {
  background-color: #2d5e33;
}


/* Cuerpo scrollable */
tbody {
  display: block;            /* bloque scrollable */
  max-height: 90%;         /* altura del scroll */
  overflow-y: auto;          /* scroll vertical */
  width: 100%;
}

/* Filas alineadas con el thead */
tbody tr {
  display: table;
  width: 100%;
  table-layout: fixed;
}

th, td {
  padding: 6px 10px;
  text-align: left;
  border-bottom: 1px solid #e0eee6;
}

th {
  background-color: #a0d3b4;
  color: #2d3e2f;
  font-weight: bold;
  position: sticky;
  top: 0;                    /* cabecera siempre visible */
  z-index: 1;
}

tr:hover {
  background-color: #e8f8e4;
  cursor: pointer;
}

    .previsualizacion {
      border: 1px solid #a0d3b4;
      border-radius: 10px;
      padding: 16px;
      width: 40%;
      background-color: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: none;
      flex-direction: column;
      justify-content: space-between;
    }

    .espacio-pdf {
      height: 700px;
      background-color: #f0f7f4;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #7aa893;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 2px dashed #a0d3b4;
    }
    .dropdown-taxones {
  position: relative;
  display: inline-block;
}

.dropbtn {
  padding: 8px;
  border: 1px solid #a0d3b4;
  border-radius: 6px;
  background-color: #f5fff8;
  font-size: 1rem;
  cursor: pointer;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #ffffff;
  min-width: 200px;
  box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
  border: 1px solid #a0d3b4;
  border-radius: 8px;
  padding: 10px;
  z-index: 1;
  flex-direction: column;
  gap: 6px;
}

.dropdown-content label {
  display: flex;
  align-items: center;
  font-size: 0.95rem;
  gap: 6px;
  margin-bottom: 4px;
  cursor: pointer;
}

.dropdown-taxones:hover .dropdown-content {
  display: flex;
  position: absolute;   /* aseg√∫rate de esto */
  z-index: 1000;
}


    .botones {
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 10px 18px;
      background-color: #3a7d44;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #2d5e33;
    }
    .thead {
      background-color: #a0d3b4;
      color: #2d3e2f;
      font-weight: bold;
      position: fixed;
      top: 0;                    /* cabecera siempre visible */
      z-index: 1;

    }

    .dropbtn {
  padding: 8px;
  border: 1px solid #a0d3b4;
  border-radius: 6px;
  background-color: #f5fff8;
  font-size: 1rem;
  color: #2d3e2f;
  min-width: 180px;
  font-family: inherit;
  text-align: left;
}




    .contenedor-mapa {
      width: 35%;
      text-align: center;
    }

    .mapa-img {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 2px solid #a0d3b4;
    }
  </style>
</head>

<body>
  <header>üåø Explorador de Rutas Naturales</header>

  

  <div class="filtros">
    
    <div class="dropdown-taxones">
      <button type="button" class="dropbtn">Grupos Taxon√≥micos ‚Æü</button>
      <div class="dropdown-content">
        <label><input type="checkbox" value="peces"> Peces</label>
        <label><input type="checkbox" value="Mam√≠feros"> Mam√≠feros</label>
        <label><input type="checkbox" value="Hongos"> Hongos</label>
        <label><input type="checkbox" value="Plantas_vasculares"> Plantas vasculares</label>
        <label><input type="checkbox" value="Plantas_no_vasculares"> Plantas no vasculares</label>
        <label><input type="checkbox" value="Aves"> Aves</label>
        <label><input type="checkbox" value="Invertebrados"> Invertebrados</label>
        <label><input type="checkbox" value="anfibios"> Anfibios</label>
        <label><input type="checkbox" value="reptiles"> Reptiles</label>
      </div>
    </div>
    
    <select id="provincia-selector" name="provincia">
      <option value="">Provincia</option>
      <option value="Araba/√Ålava">√Ålava</option>
      <option value="albacete">Albacete</option>
      <option value="Alacant/Alicante">Alicante</option>
      <option value="almer√≠a">Almer√≠a</option>
      <option value="asturias">Asturias</option>
      <option value="√Åvila">√Åvila</option>
      <option value="badajoz">Badajoz</option>
      <option value="barcelona">Barcelona</option>
      <option value="Bizkaia">Bizkaia</option>
      <option value="burgos">Burgos</option>
      <option value="c√°ceres">C√°ceres</option>
      <option value="c√°diz">C√°diz</option>
      <option value="cantabria">Cantabria</option>
      <option value="Castell√≥/Castell√≥n">Castell√≥n</option>
      <option value="ceuta">Ceuta</option>
      <option value="Ciudad Real">Ciudad Real</option>
      <option value="C√≥rdoba">C√≥rdoba</option>
      <option value="cuenca">Cuenca</option>
      <option value="girona">Girona</option>
      <option value="granada">Granada</option>
      <option value="guadalajara">Guadalajara</option>
      <option value="Gipuzkoa">Guip√∫zcoa</option>
      <option value="huelva">Huelva</option>
      <option value="huesca">Huesca</option>
      <option value="Illes Balears">Illes Balears</option>
      <option value="ja√©n">Ja√©n</option>
      <option value="a coru√±a">A Coru√±a</option>
      <option value="la rioja">La Rioja</option>
      <option value="las palmas">Las Palmas</option>
      <option value="le√≥n">Le√≥n</option>
      <option value="lleida">Lleida</option>
      <option value="lugo">Lugo</option>
      <option value="madrid">Madrid</option>
      <option value="m√°laga">M√°laga</option>
      <option value="melilla">Melilla</option>
      <option value="murcia">Murcia</option>
      <option value="navarra">Navarra</option>
      <option value="ourense">Ourense</option>
      <option value="palencia">Palencia</option>
      <option value="pontevedra">Pontevedra</option>
      <option value="salamanca">Salamanca</option>
      <option value="san sebasti√°n">San Sebasti√°n</option>
      <option value="Santa Cruz de Tenerife">Santa Cruz de Tenerife</option>
      <option value="segovia">Segovia</option>
      <option value="sevilla">Sevilla</option>
      <option value="soria">Soria</option>
      <option value="tarragona">Tarragona</option>
      <option value="teruel">Teruel</option>
      <option value="toledo">Toledo</option>
      <option value="Val√®ncia/Valencia">Valencia</option>
      <option value="valladolid">Valladolid</option>
      <option value="zamora">Zamora</option>
      <option value="zaragoza">Zaragoza</option>
    </select>

    

    <input type="date" name="fecha">

    <button id="btn-aplicar-filtros">Aplicar filtros</button>
  </div>

  

  <div class="contenido">
    <table table id="tabla-rutas">
      <thead>
        <tr>
          <th>Ruta</th>
          <th>Etapa</th>
          <th>Longitud (Km)</th>
          <th>Provincia</th>
          <th>CCAA</th>

        </tr>
      </thead>
      <tbody>
        <!-- aqu√≠ se inyectan las filas -->
      </tbody>
    </table>

    <div class="contenedor-mapa" id="mapa">
      <img src="{{ url_for('static', filename='mapa_espana.png') }}" alt="Mapa" class="mapa-img">
    </div>

    <div class="previsualizacion" id="previsualizacion">
      <div class="espacio-pdf">
        <iframe id="visor-pdf" width="100%" height="100%" frameborder="0"></iframe>
      </div>
    
     
      <div class="controls">
        <input type="text"
               placeholder="indique como quiere sus descripciones"
               class="descripcion-input">
        <button class="descripcion-btn">Aplicar</button>
      </div>
    </div>
    

    <script>
  // 1) Cach√© simple para especies por ruta
  const especiesCache = {};

  // 2) Leer taxonom√≠as marcadas, normalizadas a min√∫sculas y sin espacios
  function obtenerTaxonomiasSeleccionadas() {
    return Array.from(
      document.querySelectorAll('.dropdown-content input[type="checkbox"]:checked')
    )
    .map(cb => cb.value.trim().toLowerCase());
  }

  // 3) Funci√≥n para vaciar la cach√© cuando cambie un filtro
  function limpiarCacheEspecies() {
    Object.keys(especiesCache).forEach(k => delete especiesCache[k]);
  }

  // 4) Asignamos el listener a cada checkbox
  document.querySelectorAll('.dropdown-content input[type="checkbox"]')
    .forEach(cb => cb.addEventListener('change', limpiarCacheEspecies));

  // 5) Y tambi√©n al bot√≥n ‚ÄúAplicar filtros‚Äù (si lo usas para provincia u otros filtros)
  document.getElementById('btn-aplicar-filtros')
    .addEventListener('click', limpiarCacheEspecies);

  // 6) La funci√≥n principal de carga, ya sin cambios
  async function cargarEspecies(ID_Ruta) {
    if (especiesCache[ID_Ruta]) {
      return especiesCache[ID_Ruta];
    }
    const payload = {
      id_ruta:    ID_Ruta,
      taxonomias: obtenerTaxonomiasSeleccionadas()
    };
    const res = await fetch('/obtener_especies', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      console.error('Error al obtener especies', await res.text());
      return [];
    }
    const lista = await res.json();
    console.log('üì• especies recibidas:', lista);
    especiesCache[ID_Ruta] = lista;
    return lista;
  }

  // 7) Mostrar la previsualizaci√≥n como antes
  async function mostrarPrevisualizacion(tr) {
    limpiarCacheEspecies();  // opcional: garantizamos siempre datos frescos
    document.getElementById('mapa').style.display = 'none';
    document.getElementById('previsualizacion').style.display = 'flex';

    const idRuta   = tr.dataset.id;
    const nombre   = tr.cells[0].textContent;
    const duracion = tr.cells[1].textContent;
    const longitud = tr.cells[2].textContent;

    const especies = await cargarEspecies(idRuta);

    const resp = await fetch('/generar_pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_ruta: idRuta, nombre, duracion, longitud, especies })
    });
    if (!resp.ok) { console.error(await resp.text()); return; }
    const blob = await resp.blob();
    document.getElementById('visor-pdf').src = URL.createObjectURL(blob);
  }

  // ... el resto de tu script (cargarRutas, DOMContentLoaded) ...
</script>

    
   <script>
    async function cargarRutas(provincia = '') {
      // Construye la URL con query param
      const url = '/obtener_rutas' + (provincia ? `?provincia=${encodeURIComponent(provincia)}` : '');
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const rutas = await resp.json();
    
      const tbody = document.querySelector('#tabla-rutas tbody');
      tbody.innerHTML = '';
    
      rutas.forEach(r => {
        const tr = document.createElement('tr');
        tr.dataset.id = r.ID_Ruta;
        tr.onclick = () => mostrarPrevisualizacion(tr);
        tr.innerHTML = `
          
          <td>${r.Nombre_Ruta}</td>
          <td>${r.Nombre_Etapa}</td>
          <td>${r.Longitud}</td>
          <td>${r.Provincia}</td>
          <td>${r.CCAA}</td>

        `;
        tbody.appendChild(tr);
      });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      // Carga inicial sin filtros
      cargarRutas();
    
      // Aplica filtros al bot√≥n
      document.getElementById('btn-aplicar-filtros').addEventListener('click', () => {
        const sel = document.getElementById('provincia-selector').value;
        cargarRutas(sel);
      });
    });
    </script>
    
    
  
</body>
</html>
